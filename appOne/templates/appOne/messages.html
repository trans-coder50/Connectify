{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="{%static '/css/messages.css'%}">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto&display=swap" rel="stylesheet">
      <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
      <style>
        .create-post  input[type="text"]{
    width:95%;
    height: 200px;
    margin-top: 10px;
    border-radius: 10px;
    border: solid 2px var(--pink);
}
      </style>
    <title>Connectify</title>
</head>
<body>
    <nav>
        <div class="logo">
            <h1>Connectify</h1>
        </div>
        <div>
            <ul class="navigation-one">
                    <li>
                        <a href="{%url 'home'%}">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16"  fill="white" >
                        <path  d="M8.707 1.5a1 1 0 0 0-1.414 0L.646 8.146a.5.5 0 0 0 .708.708L8 2.207l6.646 6.647a.5.5 0 0 0 .708-.708L13 5.793V2.5a.5.5 0 0 0-.5-.5h-1a.5.5 0 0 0-.5.5v1.293L8.707 1.5Z"/>
                        <path d="m8 3.293 6 6V13.5a1.5 1.5 0 0 1-1.5 1.5h-9A1.5 1.5 0 0 1 2 13.5V9.293l6-6Z"/>
                        </svg>
                        </a>
                    </li>
                    <li>
                        <a href="{%url 'notification'%}">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="white" class="bi bi-bell-fill" >
                        <path d="M8 16a2 2 0 0 0 2-2H6a2 2 0 0 0 2 2zm.995-14.901a1 1 0 1 0-1.99 0A5.002 5.002 0 0 0 3 6c0 1.098-.5 6-2 7h14c-1.5-1-2-5.902-2-7 0-2.42-1.72-4.44-4.005-4.901z"/>
                        </svg>
                        </a>
                    </li>
                    <li>
                        <a href="{%url 'messages'%}">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="white" class="bi bi-chat-fill" viewBox="0 0 16 16">
                        <path d="M8 15c4.418 0 8-3.134 8-7s-3.582-7-8-7-8 3.134-8 7c0 1.76.743 3.37 1.97 4.6-.097 1.016-.417 2.13-.771 2.966-.079.186.074.394.273.362 2.256-.37 3.597-.938 4.18-1.234A9.06 9.06 0 0 0 8 15z"/>
                        </svg>
                        </a>
                    </li>
                    <li>
                        <a href="{%url 'invitation'%}">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="white" class="bi bi-people-fill" viewBox="0 0 16 16">
                        <path d="M7 14s-1 0-1-1 1-4 5-4 5 3 5 4-1 1-1 1H7Zm4-6a3 3 0 1 0 0-6 3 3 0 0 0 0 6Zm-5.784 6A2.238 2.238 0 0 1 5 13c0-1.355.68-2.75 1.936-3.72A6.325 6.325 0 0 0 5 9c-4 0-5 3-5 4s1 1 1 1h4.216ZM4.5 8a2.5 2.5 0 1 0 0-5 2.5 2.5 0 0 0 0 5Z"/>
                        </svg>
                        </a>
                    </li>
                    <li>
                        <a href="{%url 'search'%}">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="white" class="bi bi-search" viewBox="0 0 16 16">
                        <path d="M11.742 10.344a6.5 6.5 0 1 0-1.397 1.398h-.001c.03.04.062.078.098.115l3.85 3.85a1 1 0 0 0 1.415-1.414l-3.85-3.85a1.007 1.007 0 0 0-.115-.1zM12 6.5a5.5 5.5 0 1 1-11 0 5.5 5.5 0 0 1 11 0z"/>
                        </svg>
                        </a>
                    </li>
                    <li class="profile-img">
                        <img src="{{profile.profileImg.url}}" alt="" srcset="">
                    </li>
            </ul>
        </div>
    </nav>
    <div class="sub-nav">
        <ul class="navigation-two">
                    <li>
                        <a href="{%url 'home'%}">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16"  fill="white" >
                        <path  d="M8.707 1.5a1 1 0 0 0-1.414 0L.646 8.146a.5.5 0 0 0 .708.708L8 2.207l6.646 6.647a.5.5 0 0 0 .708-.708L13 5.793V2.5a.5.5 0 0 0-.5-.5h-1a.5.5 0 0 0-.5.5v1.293L8.707 1.5Z"/>
                        <path d="m8 3.293 6 6V13.5a1.5 1.5 0 0 1-1.5 1.5h-9A1.5 1.5 0 0 1 2 13.5V9.293l6-6Z"/>
                        </svg>
                        </a>
                    </li>
                    <li>
                        <a href="{%url 'notification'%}">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="white" class="bi bi-bell-fill" >
                        <path d="M8 16a2 2 0 0 0 2-2H6a2 2 0 0 0 2 2zm.995-14.901a1 1 0 1 0-1.99 0A5.002 5.002 0 0 0 3 6c0 1.098-.5 6-2 7h14c-1.5-1-2-5.902-2-7 0-2.42-1.72-4.44-4.005-4.901z"/>
                        </svg>
                        </a>
                    </li>
                    <li>
                        <a href="{%url 'messages'%}">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="white" class="bi bi-chat-fill" viewBox="0 0 16 16">
                        <path d="M8 15c4.418 0 8-3.134 8-7s-3.582-7-8-7-8 3.134-8 7c0 1.76.743 3.37 1.97 4.6-.097 1.016-.417 2.13-.771 2.966-.079.186.074.394.273.362 2.256-.37 3.597-.938 4.18-1.234A9.06 9.06 0 0 0 8 15z"/>
                        </svg>
                        </a>
                    </li>
                    <li>
                        <a href="{%url 'invitation'%}">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="white" class="bi bi-people-fill" viewBox="0 0 16 16">
                        <path d="M7 14s-1 0-1-1 1-4 5-4 5 3 5 4-1 1-1 1H7Zm4-6a3 3 0 1 0 0-6 3 3 0 0 0 0 6Zm-5.784 6A2.238 2.238 0 0 1 5 13c0-1.355.68-2.75 1.936-3.72A6.325 6.325 0 0 0 5 9c-4 0-5 3-5 4s1 1 1 1h4.216ZM4.5 8a2.5 2.5 0 1 0 0-5 2.5 2.5 0 0 0 0 5Z"/>
                        </svg>
                        </a>
                    </li>
                    <li>
                        <a href="{%url 'search'%}">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="white" class="bi bi-search" viewBox="0 0 16 16">
                        <path d="M11.742 10.344a6.5 6.5 0 1 0-1.397 1.398h-.001c.03.04.062.078.098.115l3.85 3.85a1 1 0 0 0 1.415-1.414l-3.85-3.85a1.007 1.007 0 0 0-.115-.1zM12 6.5a5.5 5.5 0 1 1-11 0 5.5 5.5 0 0 1 11 0z"/>
                        </svg>
                        </a>
                    </li>
            </ul>
    </div>
    <div class="profile-cart">
        <ul>
            <li><a href="{%url 'profile'%}">Profile</a></li>
            <li class="click-to-create-post">Posting</li>
            <li><a href="{%url 'saves'%}">Saves</a></li>
            <li><a href="{%url 'logout'%}">Log out</a></li>
        </ul>
    </div>
    <div class="container">
        <div class="discuss" id="" style="display: none;">
            <div class="friend">
                <div class="friend-info" id="0">
                    <img src="assets/film25.jpg" alt="" srcset="">
                    <h4>JOHN WICK</h4>
                </div>
               
            </div>
            <div class="messages" >
                
                
            </div>
            <div class="send">
                <form action="" method="post" id="send_message_form" >
                       {% csrf_token %}
                    <input type="text" name="" id="input-message" >
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-send-fill" viewBox="0 0 16 16">
                    <path d="M15.964.686a.5.5 0 0 0-.65-.65L.767 5.855H.766l-.452.18a.5.5 0 0 0-.082.887l.41.26.001.002 4.995 3.178 3.178 4.995.002.002.26.41a.5.5 0 0 0 .886-.083l6-15Zm-1.833 1.89L6.637 10.07l-.215-.338a.5.5 0 0 0-.154-.154l-.338-.215 7.494-7.494 1.178-.471-.47 1.178Z"/>
                    </svg>
                    <input type="submit" class="fr-sub" value="sub" style="display: none;">
                </form>
            </div>
        </div>

        <div class="friends">
            <div class="titel">
                <h3>Friends</h3>
            </div>
            <div class="friends-list">
             {%for friend in friendship%}  
             {%if friend.user1 == profile.username %}
             {%for i in profiles%}
             {%if friend.user2 == i.username%}
               
                 <div id="{{friend.user2.id}}">
                    <img src="{{i.profileImg.url}}" alt="" srcset="">
                    <h4>{{friend.user2}}</h4>
                </div>
              
                {%endif%}
               {%endfor%}

               {%else%}
            {%for i in profiles%}
             {%if friend.user1 == i.username%} 
             
                 <div id="{{friend.user1.id}}">
                    <img src="{{i.profileImg.url}}" alt="" srcset="">
                    <h4>{{friend.user1}}</h4>
                </div>
              
               {%endif%}
            {%endfor%}
            {%endif%}
            {%endfor%}
                
            </div>
        </div>
    </div>
    <div class="create-post" >
        <form action="" method="post" enctype="multipart/form-data">
        {% csrf_token %}
        <input type="text" name="postContent" id="" placeholder="write something...">
        <input type="file" name="postImage" id="select-image-input" accept="image/*">
        <div class="select-image">
            <img src="{% static 'assets/image.svg'%}" alt="" class="img">
            <img src="#" alt="" srcset="" class="selected-image">
        </div>
        <input type="submit" value="Post" id="create-post-submet">
        </form>

    </div>
    <div class="create-post-click-outside"></div>
    <input type="hidden" id="logged-in-user" value="{{ user.id }}">
   
    <script>
let profileCart = document.querySelector(".profile-cart");
let profileImage = document.querySelector(".profile-img");
let clickToCreatePost = document.querySelector(".click-to-create-post");
let createPost = document.querySelector(".create-post");
let createPostClickOutside = document.querySelector(".create-post-click-outside");
let selectImage = document.querySelector(".select-image");
let selectImageImg = document.querySelector(".select-image .img");
let selectImageInput = document.querySelector("#select-image-input");
let selectedImage = document.querySelector(".selected-image");
let friendInfo = document.querySelector(".friend-info");
let friendInfoImg = document.querySelector(".friend-info img");
let friendInfoH4 = document.querySelector(".friend-info h4");
let friendsList = document.querySelectorAll(".friends-list div");
let friends_list = document.querySelector(".friends-list");
let svgSender = document.querySelector('.bi-send-fill')
let t=0
let messages=document.querySelector('.messages')
let discuss = document.querySelector(".discuss")



svgSender.addEventListener("click",function(){
document.querySelector(".fr-sub").click()
})

friendsList.forEach(function(e){
e.addEventListener("click",function(){
    discuss.style.display="block"
    Array.from(messages.children).forEach(child => child.remove());
    usId = e.id
    friendInfo.id = usId
     var xhr = new XMLHttpRequest();
        xhr.open("POST", "{% url 'userStaff' %}", true);
        xhr.setRequestHeader("Content-Type", "application/x-www-form-urlencoded");
        xhr.setRequestHeader("X-CSRFToken", "{{ csrf_token }}");
        xhr.onreadystatechange = function() {
        if (xhr.readyState === XMLHttpRequest.DONE && xhr.status === 200) {
            var response = JSON.parse(xhr.responseText);
            user = response.user
            url = response.url
            room = response.room_id
             friendInfoImg.src = url
             friendInfoH4.innerHTML = user
             t=room
             messager=response.messages
             
             for (i in messager){
              
                 if(messager[i].id ==USER_ID){
                    
 child = document.createElement("div")
 child.classList.add("my-messages")
 child.innerHTML = messager[i].message
messages.append(child)
    }else if(messager[i].id == friendInfo.id){
        child = document.createElement("div")
 child.classList.add("his-messages")
 child.innerHTML = messager[i].message
messages.append(child)
    }
             }
          }
        };
        xhr.send("id=" + usId); 
        
})
})

window.addEventListener("scroll", function () {
    profileCart.classList.remove("cart-show")
    profileCart.style.transform = "scale(0)";
    profileCart.style.transition = "transform 0.2s";
})
selectImageInput.addEventListener("change", function () {
    selectImageImg.style.display = "none";
    selectedImage.style.display = "block";
     let reader = new FileReader();
    reader.readAsDataURL(selectImageInput.files[0]);
    reader.onload = () => { 
         selectedImage.setAttribute("src", reader.result);
    }
})

selectImage.addEventListener("click", function () {
    selectImageInput.click();
})
clickToCreatePost.addEventListener("click", function () {
    createPost.style.display = "flex";
    createPostClickOutside.style.display = "block";
    profileCart.classList.remove("cart-show")
    profileCart.style.transform = "scale(0)";
    profileCart.style.transition = "transform 0.2s";
})
createPostClickOutside.addEventListener("click", function () {
    createPost.style.display = "none";
    createPostClickOutside.style.display = "none";
})
profileImage.addEventListener("click", function () {
    profileCart.classList.toggle("cart-show");
    if (profileCart.classList.contains("cart-show")) {
        profileCart.style.transform = "scale(1)";
        profileCart.style.transition = "transform 0.5s";
    } else {
        profileCart.style.transform = "scale(0)";
        profileCart.style.transition = "transform 0.5s";
    }
})




let send_message_form = $('#send_message_form')
let input_message = $('#input-message')
const USER_ID = $('#logged-in-user').val()
let ds = $('.discuss')
let loc = window.location
let wsStart = 'ws://'

if(loc.protocol === 'https') {
    wsStart = 'wss://'
}
let endpoint = wsStart + loc.host + loc.pathname

var socket = new WebSocket(endpoint)

socket.onopen = async function(e){
    console.log('open', e)
    send_message_form.on('submit', function (e){
        e.preventDefault()
        let message = input_message.val()
        let send_to = friendInfo.id
        let room = t
        let data = {
            'message': message,
            'sent_by': USER_ID,
            'send_to': send_to,
            'room': room
        }
        data = JSON.stringify(data)
        socket.send(data)
        $(this)[0].reset()
    })
}

socket.onmessage = async function(e){
    console.log('message', e)
    let data = JSON.parse(e.data)
    let message = data['message']
    let sent_by_id = data['sent_by']
    let room= data['room']
    
    newMessage(message, sent_by_id, room)
}

socket.onerror = async function(e){
    console.log('error', e)
}

socket.onclose = async function(e){
    console.log('close', e)
}
function newMessage(message, sent_by_id, room){
    if(sent_by_id ==USER_ID){
 child = document.createElement("div")
 child.classList.add("my-messages")
 child.innerHTML = message

messages.append(child)
    }else if(sent_by_id == friendInfo.id){
        child = document.createElement("div")
 child.classList.add("his-messages")
 child.innerHTML = message
messages.append(child)
    }
   
   
}
    </script>
</body>
</html>